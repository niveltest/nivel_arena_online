# 実装計画: コンテンツとルールの深化 (AIの多様化 & 解決順序の厳密化)

AIに対戦のバリエーション（性格）を持たせ、ゲームルールの根幹である効果解決の順序をより厳密に制御できるようにします。

## ユーザーレビューが必要な項目

- **AIの性格設定**: 現在「アグロ（速攻）」「コントロール（守備）」「バランス」を想定していますが、他にも希望があれば追加可能です。
- **解決順序の仕様**: 複数の効果が同時に発動した際、現在は「ターンプレイヤー優先、その後非ターンプレイヤー」という一般的なTCGルールで設計しますが、ニケ公式に特有のルールがあれば調整します。

## 変更内容

### [Component] AIPlayer (`server/AIPlayer.ts`)

- **性格（Personality）の導入**:
  - `AGGRO`: リーダーへのダメージを最優先。バフをダメージに、デバフを無視する傾向。
  - `CONTROL`: 盤面の除去を最優先。高コストの除去やバウンスを重視。
  - `BALANCED`: 現在のロジック（トレード効率重視）。
- **ロジックの調整**:
  - `evaluateThreat` 内の各要素（パワー、特殊能力、除去価値）に対する重み付けを性格ごとに定数化。
  - マリガン判断やメインフェーズの優先順位に性格を反映。

### [Component] Game Logic (`server/Game.ts`)

- **効果解決キュー (`effectQueue`) の実装**:
  - 効果を即時実行するのではなく、一度キューにスタックする仕組みを導入。
  - 同時に複数の `ON_DESTROY` や `ON_PLAY` が発生した際に、解決順序（ターンプレイヤー優先など）を保証。
- **解決フェーズの分離**:
  - `applyEffect` を「キューへの追加」と「キューの処理」に分離し、複雑な効果の連鎖を正しく処理。

## 検証プラン

### 自動テスト

- `server/testData/unitTestAIRuleRefinement.ts` を作成し、以下の挙動を確認：
  - アグロAIが盤面無視でリーダーを狙うこと。
  - コントロールAIが積極的に除去カードを使用すること。
  - 複数の破壊時効果がキューイングされ、正しい順序で解決されること。

### 手動検証

- ブラウザ上のデバッグログを確認し、効果の解決順序が意図通りであることを確認。
- 異なる性格のCPUと対戦し、戦術の違いを体感。
