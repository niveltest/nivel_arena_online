# 修正内容の確認 (Walkthrough) - 高度なカード効果とアクティブスキルの実装

カード効果の自動パース精度を向上させ、アクティブスキルやアイテムの動的なステータス計算、高度な効果（手札破棄、スタンなど）を実装しました。

## 主な変更点

### 1. 効果パーススクリプトの強化 (`populate_effects.ts`)

- **アクティブスキルの自動検知**: `【起】` や `[メイン]` などのキーワードからアクティブスキルを識別し、`ACTIVE` トリガーを設定するようにしました。
- **ターゲットと条件の拡張**: 「対向ユニット」(`OPPOSING`) や「全ての相手ユニット」(`ALL_ENEMIES`)、また「自分のターン中」(`MY_TURN`) や「相手の手札が3枚以上」(`HAND_GE_3`) などの条件を判別可能にしました。
- **新規アクションの追加**: ヒット修正 (`SET_HIT`)、手札破棄 (`DISCARD`)、スタン (`STUN_UNIT`) のパース処理を追加しました。
- **アイテム・スキルのデフォルト処理**: 明示的なキーワードがない場合、アイテムは `PASSIVE`、スキルは `ON_PLAY` として効果を抽出するフォールバックを追加しました。

### 2. サーバー側ゲームロジックの改善 (`Game.ts`)

- **アクティブスキルの発動ロジック**: `useActiveAbility` メソッドを実装し、コスト支払いや効果適用後の状態チェック（SBA）を統合しました。
- **アイテムの動的計算**: ユニットに装備（アタッチ）されているアイテムのパワーやヒット修正を、戦闘時に動的に計算するように `getUnitPower` と `getUnitHitCount` を更新しました。
- **高度な効果の実装**:
  - `OPPOSING`: 対向するスロットのユニットを対象にする処理を追加。
  - `DISCARD`: 相手に手札から1枚選んで捨てるように選択を要求する処理を追加。
  - `STUN_UNIT`: 単体、対向、全体のスタン処理を追加。

### 3. クライアント側 UI の対応

- **アクティブスキルボタン**: `Card.tsx` に「Activate」ボタンを追加しました。自分自身のターンかつメインフェイズのみ表示されます。
- **イベント連携**: `GameBoard.tsx` でボタンクリック時のイベント送信を実装し、サーバーにアクティブスキルの使用を通知します。
- **選択モーダルの拡張**: `SelectionModal.tsx` で相手からの手札破棄要求を識別し、適切なタイトルを表示するようにしました。

## 検証結果

### 自動テスト / スクリプト実行

- `populate_effects.ts` を実行し、165枚のカードに対して高度な効果が正しく付与されていることを確認しました。
- `ST05-016` (ヒット+1されるアイテム) などが正しく `PASSIVE` 効果としてパースされていることを確認しました。

### 手動検証 (シミュレーション)

- `Game.ts` 内でアクティブスキルの呼び出し、および破壊後の `ON_DESTROY` 効果の連鎖が正しく動作することを確認しました。
- `getUnitPower` において、リーダーのパッシブ効果とアイテムの修正が重畳して計算されることをコードレベルで検証しました。

---

> [!NOTE]
> これにより、スターターデッキやブースターパックの複雑なカード効果の多くが自動的に機能するようになりました。
