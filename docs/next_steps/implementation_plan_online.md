# 実装計画: オンライン対戦環境の整備とセッション永続化

## 概要

プレイヤーがブラウザをリフレッシュ（再読み込み）しても対戦を継続できるように、クライアント側でのセッション情報の保存と、サーバー側の再接続ロジックの強化を行います。また、実際のサーバー（RenderやHeroku等）へのデプロイに向けた準備を行います。

## 変更内容

### 1. クライアント側のセッション永続化 (`components/GameBoard.tsx`)

- **情報保存**:
  - `joinGame` または `createGame` が成功した際に、`username` と `roomId` を `localStorage` に保存します。
- **自動再参加**:
  - コンポーネントの `useEffect` (初期化時) にて、`localStorage` に有効な `roomId` が存在する場合、自動的にサーバーへ `joinGame` をリクエストします。
- **情報クリア**:
  - ゲーム終了時（ResultModal表示時）や、ユーザーが明示的にロビーに戻る際に `localStorage` をクリアします。

### 2. サーバー側の再接続ロジックの安定化 (`server/Game.ts`)

- **ID移行の検証**:
  - 現在の `handleReconnect` では `socket.id` (playerId) が変わるため、`migratePlayerReferences` を通じて `turnPlayerId` や攻撃対象の参照が正しく更新されているか再確認します。

### 3. デプロイ準備

- **Dockerfile の作成**:
  - コンテナ化により、任意のホスティング環境で動作可能にします。
- **環境変数の整理**:
  - `CLIENT_URL` や `PORT` などの設定を `.env` で管理し、本番環境に対応させます。

## 検証計画

### 手動検証

1. **リフレッシュ耐性**: CPU対戦中にページをリフレッシュし、自動的に元の部屋に戻り、ゲーム状態が復元されることを確認します。
2. **切断タイマー**: ブラウザを閉じた後、一定時間（現在の設定では30秒）以内に戻れば継続でき、時間を過ぎると敗北扱いになることを確認します。

### 自動テスト

- `unitTestReconnect.ts` (新規) にて、疑似的なソケット切断と再接続を行わせ、ゲーム状態が整合性を保っているかをテストします。
