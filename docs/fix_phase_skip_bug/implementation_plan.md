# フェイズ自動スキップバグ修正計画

ターン8以降（あるいは手札上限チェック発生時）に、AIが誤って人間のプレイヤーのフェイズをスキップしてしまう問題を修正します。

## 原因分析

* `AIPlayer.ts` の `think()` メソッドにおいて、ガード条件（自ターンかどうかのチェック）が「思考待ち（1秒の待機）」の前のみ行われています。
* AIのターン終了時に手札上限（7枚）を超えた際、`requestSelection` が呼ばれます。
* AIの `think()` は「選択中」のためガードを通過し、1秒待機し始めます。
* 待機中に選択が解消され、フェイズが遷移して人間のターン（`LEVEL_UP` フェイズ）が開始されます。
* AIの `think()` が目覚め、現在のフェイズ（`LEVEL_UP` や `DRAW`）を見て `nextPhase()` を呼び出してしまいます。これが連続して発生し、`MAIN` フェイズまでスキップされてしまいます。

## 修正内容

### AI思考メソッドの堅牢化

* [MODIFY] [AIPlayer.ts](file:///c:/Users/worke/Antigravity/nivel_arena_online/server/AIPlayer.ts)
  * 1秒の待機（`await`）の直後に、再度ガード条件（自ターン、または自身が選択中であるか）をチェックするようにします。
  * 他人のフェイズ中に `nextPhase()` を呼び出すことを防ぎます。

## 検証プラン

* ビルドが通ることを確認。
* （ユーザー検証）
  * ターン8以降、または手札を多く持っている状態でAIのターンが終わった後に、自分のターンのフェイズ（LEVEL_UP, DRAW, MAIN）がスキップされずに表示されることを確認。
