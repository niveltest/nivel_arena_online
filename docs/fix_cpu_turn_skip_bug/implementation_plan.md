# CPU戦フェイズ自動進行バグ修正計画

CPU戦において、プレイヤーのターン中にCPUがフェイズを進行させてしまう不具合を修正します。

## 課題の分析

- **原因**: `AIPlayer.ts` の `think()` メソッドにおいて、セレクション要求（カード選択効果など）によってCPUが思考状態に入った際、現在のフェイズが `MAIN` や `ATTACK` だと、たとえ自分（CPU）のターンでなくてもフェイズ進行ロジックが走ってしまう。
- **結果**: CPUが「自分ができるメインアクションがない」と判断し、`nextPhase()` を呼び出すことで、プレイヤーのメインフェイズを勝手に終了させてしまう。

## 修正内容

### 1. CPU思考ロジックの修正 (`AIPlayer.ts`)

* [MODIFY] [AIPlayer.ts](file:///c:/Users/worke/Antigravity/nivel_arena_online/server/AIPlayer.ts)
  - `think()` メソッドの各フェイズ処理において、**「フェイズを進行させるアクション (`nextPhase()`)」を実行する前に、必ず現在のターンプレイヤーが自分自身であるかを確認する**ガードを追加します。
  - `MAIN` フェイズや `ATTACK` フェイズのハンドリング時、ターンプレイヤーでない場合は何もせずリターンするようにします。
  - デバッグを容易にするため、CPUがなぜ思考を開始したか、どのアクションをとったかのログ出力を強化します（サーバー側）。

### 2. ゲームエンジンの安全策 (`Game.ts`) (検討)

* `nextPhase()` 自体にターンプレイヤーのチェックを入れることも検討しましたが、システム全体の影響範囲が大きいため、まずは呼び出し側（AI）での制限を優先します。

## 検証プラン

* ビルドが通ることを確認。
- CPU戦において、CPUがセレクション（手札破壊効果など）を要求する状況を作り、プレイヤーのターンが維持されることを確認。
- ターン8（およびその他のターン）でフェイズが勝手に進まないことを確認。
