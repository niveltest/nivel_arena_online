
# 実装計画：追加のカードエフェクト実装

本計画では、Nivel Arena のカードに存在する「能力付与（Grant Ability）」および「累積トリガー（他のユニットが破壊された時）」のエフェクトを実装します。

## 導入される変更

### 1. 型定義の拡張 (`shared/types.ts`)

- **トリガー**: `ON_OTHER_UNIT_DESTROY` (他のユニットがトラッシュされた時) を追加。
- **アクション**: `GRANT_ABILITY` (キーワード能力の付与) を追加。
- **インターフェース**: `CardEffect` に付与するキーワードを保持する `grantedKeyword` プロパティを追加。

### 2. カード解析の強化 (`server/scripts/populate_effects.ts`)

- カードテキストから「アタッカー」「突破」「貫通」などの付与能力を抽出するロジックを実装。
- 「他のユニットがトラッシュされるたびに」というテキストを検出し、新しいトリガーを割り当てる。
- `detectTarget` ヘルパーを導入し、「選んで」等のテキストから正確なターゲットタイプ（SINGLE, ALL_ALLIES等）を判定。

### 3. ゲームエンジンの更新 (`server/Game.ts`)

- `applyEffect` 内に `GRANT_ABILITY` の処理を追加。
  - 単体対象の場合はクライアントに選択リクエスト (`GRANT_ABILITY_SELECTION`) を送信。
  - キーワードは `tempKeywords` として保存し、ターン終了時まで有効。
- `destroyUnit` メソッドを修正し、ユニットが破壊された際にフィールド上の他のユニットの `ON_OTHER_UNIT_DESTROY` エフェクトを誘発させる。

## 検証計画

### 自動テスト

- `server/test/test_new_effects.ts` を作成し、以下のケースを検証。
  - `BT01-046` (紅蓮) プレイ時に指定した味方ユニットに「アタッカー」「突破」が付与されること。
  - `BT02-020` (ギロチン) が場にある状態で他のユニットが破壊された際、パワーが上昇すること。

### 手動確認

- `cards.json` を直接確認し、対象カードに意図したエフェクトデータが生成されているか確認。
